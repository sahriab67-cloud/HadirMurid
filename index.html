<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Kehadiran Harian Murid STS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background:#f3f6fc; font-family:'Segoe UI',sans-serif; }
    .header-bar { background:#0d6efd; color:white; border-radius:10px; padding:10px 15px; display:flex; align-items:center; gap:10px; }
    .card { border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .info-box { background:white; border-radius:10px; padding:10px 20px; margin-bottom:15px; }
    .progress { height:18px; }
    input { text-align:center; }
    table input { width:100%; border:1px solid #ddd; border-radius:5px; padding:4px; }
    .saved { background:#d4edda!important; }
    .unsaved { background:#f8d7da!important; }
  </style>
</head>
<body class="p-3">
  <div class="header-bar mb-3">
    <b>Laporan Kehadiran Harian Murid STS</b>
    <div>Tarikh <input type="date" id="tarikh" class="form-control form-control-sm d-inline-block" style="width:auto;"></div>
    <div>Hari <input type="text" id="hari" class="form-control form-control-sm d-inline-block" style="width:100px;"></div>
    <button id="setHariBaru" class="btn btn-light btn-sm">Set Hari Baru</button>
    <button id="refresh" class="btn btn-light btn-sm">Segar Semula</button>
    <button id="exportCsv" class="btn btn-light btn-sm">Eksport CSV</button>
  </div>

  <div id="analisis" class="text-center mb-3">
    <div class="card p-3 d-inline-block text-center" style="min-width:260px;">
      <div><b>Kelas Isi:</b> <span id="kelasIsi">0</span> / <span id="totalKelas">0</span></div>
      <div><b>Murid Hadir:</b> <span id="muridHadir">0</span></div>
      <div><b>Peratus:</b> <span id="peratusHadir">0%</span></div>
      <div class="progress mt-2">
        <div id="barHadir" class="progress-bar bg-success" style="width:0%;"></div>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="small text-muted mb-2" id="rekodCount">Disisi: 0</div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle text-center">
        <thead class="table-primary">
          <tr>
            <th>KELAS</th><th>NAMA PENGISI</th><th>BIL. HADIR</th><th>JUMLAH MURID</th><th>CATATAN</th><th>TINDAKAN</th>
          </tr>
        </thead>
        <tbody id="jadualKelas"></tbody>
      </table>
    </div>
  </div>

  <script>
  const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbyK_qh_CV3fdyq-dsLbJCboDvTXoHs6aUlpHCq26SJAc8T3lbkslfep2nLqsDUzzTJm/exec";

  const jadualKelas = document.getElementById("jadualKelas");
  const kelasIsi = document.getElementById("kelasIsi");
  const totalKelas = document.getElementById("totalKelas");
  const muridHadir = document.getElementById("muridHadir");
  const peratusHadir = document.getElementById("peratusHadir");
  const barHadir = document.getElementById("barHadir");

  async function muatData() {
    const t = document.getElementById("tarikh").value;
    const res = await fetch(DEPLOY_URL + "?tarikh=" + t);
    const data = await res.json();
    paparJadual(data);
  }

  function paparJadual(data) {
    jadualKelas.innerHTML = "";
    let countIsi = 0, totalHadir = 0, totalMurid = 0;
    totalKelas.textContent = data.length;
    data.forEach(row => {
      const [tarikh,hari,kelas,pengisi,hadir,jumlah,catatan] = row;
      const tr = document.createElement("tr");
      const saved = pengisi || hadir || jumlah || catatan ? "saved" : "unsaved";
      tr.className = saved;

      tr.innerHTML = `
        <td>${kelas}</td>
        <td><input data-kelas="${kelas}" data-field="pengisi" value="${loadTemp(kelas,'pengisi',pengisi)}"></td>
        <td><input data-kelas="${kelas}" data-field="hadir" value="${loadTemp(kelas,'hadir',hadir)}"></td>
        <td><input data-kelas="${kelas}" data-field="jumlah" value="${loadTemp(kelas,'jumlah',jumlah)}"></td>
        <td><input data-kelas="${kelas}" data-field="catatan" value="${loadTemp(kelas,'catatan',catatan)}"></td>
        <td><button class="btn btn-sm btn-primary" onclick="simpan('${kelas}',this)">Simpan</button></td>`;
      jadualKelas.appendChild(tr);

      if (hadir && jumlah) {
        countIsi++;
        totalHadir += Number(hadir)||0;
        totalMurid += Number(jumlah)||0;
      }

      // Auto-save setiap kali taip
      tr.querySelectorAll("input").forEach(inp=>{
        inp.addEventListener("input",()=>{
          autoSaveTemp(inp.dataset.kelas, inp.dataset.field, inp.value);
        });
      });
    });
    kelasIsi.textContent = countIsi;
    muridHadir.textContent = totalHadir;
    const peratus = totalMurid ? (totalHadir/totalMurid*100).toFixed(1) : 0;
    peratusHadir.textContent = peratus + "%";
    barHadir.style.width = peratus + "%";
  }

  function autoSaveTemp(kelas, field, value) {
    const key = "hadirTemp_" + kelas;
    const data = JSON.parse(localStorage.getItem(key) || "{}");
    data[field] = value;
    localStorage.setItem(key, JSON.stringify(data));
  }

  function loadTemp(kelas, field, asal) {
    const key = "hadirTemp_" + kelas;
    const data = JSON.parse(localStorage.getItem(key) || "{}");
    return data[field] ?? asal ?? "";
  }

  function clearTemp(kelas) {
    localStorage.removeItem("hadirTemp_" + kelas);
  }

  async function simpan(kelas, btn) {
    const tr = btn.closest("tr");
    const pengisi = tr.querySelector('[data-field="pengisi"]').value.trim();
    const hadir = tr.querySelector('[data-field="hadir"]').value.trim();
    const jumlah = tr.querySelector('[data-field="jumlah"]').value.trim();
    const catatan = tr.querySelector('[data-field="catatan"]').value.trim();
    const tarikh = document.getElementById("tarikh").value;
    const hari = document.getElementById("hari").value;
    btn.disabled = true;
    btn.textContent = "Menyimpan...";

    const res = await fetch(DEPLOY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tarikh, hari, kelas, pengisi, hadir, jumlah, catatan })
    });
    const out = await res.json();
    if (out.status === "ok") {
      tr.classList.remove("unsaved");
      tr.classList.add("saved");
      clearTemp(kelas);
    }
    btn.textContent = "Simpan";
    btn.disabled = false;
    muatData();
  }

  document.getElementById("setHariBaru").onclick = async ()=>{
    const t = document.getElementById("tarikh").value;
    const h = document.getElementById("hari").value;
    if (!confirm(`Set hari baru ${t} (${h}) ?`)) return;
    await fetch(DEPLOY_URL, {method:"POST",body:JSON.stringify({action:"reset",tarikh:t,hari:h})});
    muatData();
  };

  document.getElementById("refresh").onclick = ()=>muatData();

  document.getElementById("exportCsv").onclick = ()=>{
    const rows = [...jadualKelas.querySelectorAll("tr")].map(tr=>[...tr.querySelectorAll("td")].slice(0,5).map(td=>td.textContent.trim()));
    let csv = "Kelas,Nama Pengisi,Bil Hadir,Jumlah Murid,Catatan\n" + rows.map(r=>r.join(",")).join("\n");
    const blob = new Blob([csv],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "LaporanKehadiran.csv";
    a.click();
  };

  // Auto set tarikh semasa
  document.getElementById("tarikh").value = new Date().toISOString().split("T")[0];
  muatData();
  </script>
</body>
</html>
