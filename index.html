<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laporan Kehadiran Harian Murid STS</title>
<style>
  :root{
    --blue:#0b63d6;
    --soft-blue:#e8f2ff;
    --muted:#6b7a90;
    --success:#e8fcef;
    --danger:#fff2f2;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:#f4f8ff;color:#10233b;margin:0;padding:18px}
  .wrap{max-width:1060px;margin:12px auto}
  header{display:flex;align-items:center;justify-content:space-between;background:var(--blue);color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 6px 18px rgba(11,99,214,0.12)}
  header h1{font-size:1rem;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .controls input[type=date], .controls input[type=text]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.08);color:#fff}
  .controls button{background:#fff;color:var(--blue);padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
  .controls button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.18);color:#fff}
  .card{background:var(--card);padding:14px;border-radius:10px;margin-top:14px;box-shadow:0 8px 24px rgba(16,35,59,0.06)}
  .topbar{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .topbar .info{color:var(--muted);font-weight:600}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.95rem}
  th,td{border:1px solid #e6eefc;padding:8px;text-align:center}
  th{background:var(--soft-blue);color:var(--blue);font-weight:700}
  td.left{text-align:left;padding-left:12px}
  .notfilled td{background:var(--danger)}
  .filled td{background:var(--success)}
  input.small{width:96%;padding:6px;border-radius:6px;border:1px solid #dbeafc}
  .status{margin-top:10px;text-align:center;font-weight:700;color:var(--muted)}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
  @media(max-width:820px){
    header{flex-direction:column;align-items:flex-start;gap:8px}
    .controls{flex-wrap:wrap}
    table, th, td{font-size:0.9rem}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Laporan Kehadiran Harian Murid STS</h1>
    <div class="controls" role="region" aria-label="admin-controls">
      <label style="display:flex;align-items:center;gap:6px;color:#fff">
        Tarikh
        <input id="tarikh" type="date" aria-label="Tarikh">
      </label>
      <label style="display:flex;align-items:center;gap:6px;color:#fff">
        Hari
        <input id="hari" type="text" placeholder="Contoh: Isnin" aria-label="Hari">
      </label>
      <button id="btnReset" title="Set Hari Baru">Set Hari Baru</button>
      <button id="btnRefresh" class="ghost" title="Segar Semula">Segar Semula</button>
      <button id="btnExport" class="ghost" title="Eksport CSV">Eksport CSV</button>
    </div>
  </header>

  <div class="card" role="main">
    <div class="topbar">
      <div class="info" id="countInfo">Memuat data...</div>
      <div class="actions"></div>
    </div>

    <table id="kehadiranTbl" aria-describedby="desc">
      <thead>
        <tr>
          <th style="min-width:150px">KELAS</th>
          <th>NAMA PENGISI</th>
          <th style="width:90px">BIL. HADIR</th>
          <th style="width:110px">JUMLAH MURID</th>
          <th>CATATAN</th>
          <th style="width:90px">TINDAKAN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="status" id="statusMsg">Status: menunggu muat data...</div>
    <p id="desc" style="display:none">Admin boleh set tarikh baru dengan butang "Set Hari Baru".</p>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
/* GANTIKAN dgn /exec Web App setelah deploy Apps Script */
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwxcFC7sDmu30bTqUtfQ1YAjOTWxk6GEV9hd2BjMyJFF6lkkIg4Uw1HB-oRVqC08qos/exec";
/* Senarai kelas tetap */
const KELAS_LIST = [
"1CEMPAKA","1KAA","1KENANGA","1MAWAR","1ORKID","1SEROJA",
"2CEMPAKA","2KAA","2KENANGA","2MAWAR","2ORKID","2SEROJA",
"3CEMPAKA","3KAA","3KENANGA","3MAWAR","3ORKID","3SEROJA",
"4AKAUN","4SAINS","4SENI 1","4SENI 2","4SENI 3","4TSWR",
"5AKAUN","5SAINS","5SENI 1","5SENI 2","5SENI 3","5TSWR",
"L6A1","L6A2","L6A3","L6A4","L6S1","L6S2","L6S3",
"U6A1","U6A2","U6A3","U6A4","U6S1","U6S2","U6S3"
];
/* ============================================== */

const tbody = document.querySelector("#kehadiranTbl tbody");
const statusMsg = document.getElementById("statusMsg");
const countInfo = document.getElementById("countInfo");
const tarikhEl = document.getElementById("tarikh");
const hariEl = document.getElementById("hari");
const btnReset = document.getElementById("btnReset");
const btnRefresh = document.getElementById("btnRefresh");
const btnExport = document.getElementById("btnExport");

function rowHTML(kelas, dataRow) {
  const pengisi = (dataRow && (dataRow["NAMA PENGISI"]||"")) || "";
  const hadir = (dataRow && (dataRow["BIL. HADIR"]||"")) || "";
  const jumlah = (dataRow && (dataRow["JUMLAH MURID"]||"")) || "";
  const catatan = (dataRow && (dataRow["CATATAN"]||"")) || "";
  const isFilled = pengisi && String(pengisi).trim() !== "";
  return `
    <tr class="${isFilled ? "filled" : "notfilled"}">
      <td class="left">${kelas}</td>
      <td><input class="pengisi small" data-kelas="${kelas}" value="${escapeHtml(pengisi)}" /></td>
      <td><input class="hadir small" data-kelas="${kelas}" type="number" min="0" value="${escapeHtml(hadir)}" /></td>
      <td><input class="jumlah small" data-kelas="${kelas}" type="number" min="0" value="${escapeHtml(jumlah)}" /></td>
      <td><input class="catatan small" data-kelas="${kelas}" value="${escapeHtml(catatan)}" /></td>
      <td><button class="saveBtn" data-kelas="${kelas}">Simpan</button></td>
    </tr>
  `;
}

function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* Load data for chosen date (if tarikh empty, server returns latest date sheet) */
async function loadData(){
  statusMsg.textContent = "ðŸ”„ Memuat data...";
  try {
    const tarikh = tarikhEl.value;
    const url = tarikh ? GOOGLE_WEBAPP_URL + "?date=" + encodeURIComponent(tarikh) : GOOGLE_WEBAPP_URL;
    const res = await fetch(url);
    const text = await res.text();
    let rows = [];
    try { rows = JSON.parse(text); } catch (e) {
      statusMsg.textContent = "âŒ Gagal baca data daripada server: " + text;
      console.error("parse error", e, text);
      return;
    }

    // If user didn't choose a date, try to set tarikh from first row
    if (!tarikh) {
      const first = rows.find(r => r["TARIKH"]);
      if (first && first["TARIKH"]) tarikhEl.value = first["TARIKH"];
    }
    // If hari input empty, try fill from rows
    if (!hariEl.value && rows.length) {
      const any = rows.find(r => r["HARI"]);
      if (any && any["HARI"]) hariEl.value = any["HARI"];
    }

    const map = {};
    rows.forEach(r => { if (r["KELAS"]) map[r["KELAS"]] = r; });

    tbody.innerHTML = "";
    let filled = 0;
    KELAS_LIST.forEach(k => {
      const r = map[k] || null;
      tbody.insertAdjacentHTML('beforeend', rowHTML(k, r));
      if (r && r["NAMA PENGISI"] && String(r["NAMA PENGISI"]).trim() !== "") filled++;
    });

    countInfo.textContent = `Diisi: ${filled} / ${KELAS_LIST.length}`;
    statusMsg.textContent = "âœ… Data dimuat.";
    bindSaveButtons();
  } catch (err) {
    console.error("loadData error", err);
    statusMsg.textContent = "âŒ Ralat muat data: " + err;
  }
}

function bindSaveButtons(){
  document.querySelectorAll(".saveBtn").forEach(b => {
    b.onclick = () => simpanBaris(b.dataset.kelas, b);
  });
}

async function simpanBaris(kelas, btn){
  btn.disabled = true; btn.textContent = "Menghantar...";
  const pengisi = document.querySelector(`.pengisi[data-kelas='${kelas}']`).value || "";
  const hadir = document.querySelector(`.hadir[data-kelas='${kelas}']`).value || "";
  const jumlah = document.querySelector(`.jumlah[data-kelas='${kelas}']`).value || "";
  const catatan = document.querySelector(`.catatan[data-kelas='${kelas}']`).value || "";
  const tarikh = tarikhEl.value || "";
  const hari = hariEl.value || "";

  if (!tarikh || !hari) { alert("Sila isi Tarikh & Hari di atas terlebih dahulu."); btn.disabled=false; btn.textContent="Simpan"; return; }

  const payload = { tarikh, hari, kelas, pengisi, hadir, jumlah, catatan };

  try {
    /* we use mode:no-cors to avoid CORS preflight from GitHub Pages.
       Server will still receive POST and write to sheet.
       We then reload data after a short delay. */
    await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    statusMsg.textContent = `âœ… Data kelas ${kelas} dihantar. Menunggu muat semula...`;
    setTimeout(loadData, 900);
  } catch (err) {
    console.error("POST error", err);
    statusMsg.textContent = "âŒ Gagal hantar: " + err;
  } finally {
    btn.disabled = false; btn.textContent = "Simpan";
  }
}

/* Set Hari Baru â€” create/reset sheet for chosen date with kelas rows */
btnReset.addEventListener("click", async () => {
  if (!confirm("Anda pasti nak 'Set Hari Baru'? Ini akan reset baris untuk tarikh ini.")) return;
  const tarikh = tarikhEl.value;
  const hari = hariEl.value || "";
  if (!tarikh || !hari) { alert("Sila pilih Tarikh & Hari sebelum reset."); return; }

  try {
    await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "reset", tarikh, hari })
    });
    statusMsg.textContent = "ðŸ”„ Reset dihantar. Memuat semula...";
    setTimeout(loadData, 900);
  } catch (err) {
    console.error("reset error", err);
    statusMsg.textContent = "âŒ Gagal reset: " + err;
  }
});

btnRefresh.addEventListener("click", loadData);

/* Export CSV â€” from current displayed rows */
btnExport.addEventListener("click", () => {
  const tarikh = tarikhEl.value || "tanpa_tarikh";
  const hari = hariEl.value || "";
  let csv = "Tarikh,Hari,Kelas,Nama Pengisi,Bil Hadir,Jumlah Murid,Catatan\n";
  document.querySelectorAll("#kehadiranTbl tbody tr").forEach(tr => {
    const kelas = tr.querySelector("td:first-child").textContent.trim();
    const pengisi = tr.querySelector(".pengisi").value.replace(/"/g,'""');
    const hadir = tr.querySelector(".hadir").value;
    const jumlah = tr.querySelector(".jumlah").value;
    const catatan = tr.querySelector(".catatan").value.replace(/"/g,'""');
    csv += `"${tarikh}","${hari}","${kelas}","${pengisi}","${hadir}","${jumlah}","${catatan}"\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Kehadiran_${tarikh}.csv`;
  a.click();
});

/* On load: default date = today & default hari (Malay weekday), then load data */
window.addEventListener("load", () => {
  if (!tarikhEl.value) {
    const d = new Date();
    tarikhEl.value = d.toISOString().slice(0,10);
    const hariNames = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
    hariEl.value = hariNames[d.getDay()];
  }
  loadData();
});
</script>
</body>
</html>
