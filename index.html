<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Kehadiran STS</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f4f8ff;
    color: #333;
    margin: 0;
    padding: 0;
    text-align: center;
  }
  header {
    background: #1976d2;
    color: white;
    padding: 15px;
    font-size: 1.4em;
    font-weight: 600;
  }
  .container {
    max-width: 900px;
    margin: 20px auto;
    background: white;
    border-radius: 14px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    padding: 20px;
  }
  label {
    font-weight: 600;
  }
  input, select, textarea {
    width: 100%;
    padding: 6px 8px;
    margin: 6px 0 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
  }
  button {
    background: #1976d2;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover {
    background: #0d47a1;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 14px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    font-size: 14px;
  }
  th {
    background: #1976d2;
    color: white;
  }
  .analisis-box {
    background: #e3f2fd;
    border-radius: 12px;
    margin: 15px auto;
    padding: 10px;
    width: 80%;
    font-weight: 600;
  }
  .saved {
    color: green;
    font-weight: bold;
  }
  .error {
    color: red;
    font-weight: bold;
  }
</style>
</head>
<body>

<header>
  Laporan Kehadiran Harian STS
</header>

<div class="container">
  <h3 id="tarikh-hari"></h3>
  <div id="analisis" class="analisis-box">Menunggu data...</div>

  <form id="formKehadiran">
    <label for="kelas">Kelas:</label>
    <select id="kelas" name="kelas"></select>

    <label for="pengisi">Nama Pengisi:</label>
    <input type="text" id="pengisi" name="pengisi">

    <label for="hadir">Bil. Hadir:</label>
    <input type="number" id="hadir" name="hadir">

    <label for="jumlah">Jumlah Murid:</label>
    <input type="number" id="jumlah" name="jumlah">

    <label for="catatan">Catatan:</label>
    <textarea id="catatan" name="catatan" rows="2"></textarea>

    <button type="submit">üíæ Simpan</button>
    <span id="status"></span>
  </form>

  <table id="jadual">
    <thead>
      <tr>
        <th>Kelas</th><th>Pengisi</th><th>Hadir</th><th>Jumlah</th><th>Peratus</th><th>Catatan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbwdf6yJh7km4aC2JT3hsIaYnmTAfK4ebSXBeAlyBk_Tc9LurpdAbkmPiygqBj8CVzKp/exec";

// === Auto tarikh & hari ===
const now = new Date();
const hariList = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
const hari = hariList[now.getDay()];
const tarikh = now.toISOString().split('T')[0];
document.getElementById("tarikh-hari").innerText = `${tarikh} (${hari})`;

// === Muat data dari Google Sheet ===
async function loadData() {
  try {
    const res = await fetch(`${DEPLOY_URL}?tarikh=${tarikh}`);
    const data = await res.json();
    isiJadual(data);
  } catch (err) {
    console.error(err);
  }
}

// === Isi jadual ===
function isiJadual(data) {
  const tbody = document.querySelector("#jadual tbody");
  tbody.innerHTML = "";
  let jumlahKelas = 0, jumlahIsi = 0, totalHadir = 0, totalMurid = 0;

  const kelasSelect = document.getElementById("kelas");
  kelasSelect.innerHTML = "";

  data.forEach(row => {
    const [tar, hari, kelas, pengisi, hadir, jumlah, catatan] = row;
    if (!kelas) return;
    jumlahKelas++;
    const peratus = (hadir && jumlah) ? Math.round((hadir/jumlah)*100) : 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${kelas}</td>
      <td>${pengisi || ""}</td>
      <td>${hadir || ""}</td>
      <td>${jumlah || ""}</td>
      <td>${peratus ? peratus+"%" : ""}</td>
      <td>${catatan || ""}</td>
    `;
    tbody.appendChild(tr);

    // select options
    const opt = document.createElement("option");
    opt.value = kelas;
    opt.textContent = kelas;
    kelasSelect.appendChild(opt);

    if (hadir && jumlah) {
      jumlahIsi++;
      totalHadir += Number(hadir);
      totalMurid += Number(jumlah);
    }
  });

  // Analisis
  const analisisBox = document.getElementById("analisis");
  if (jumlahIsi > 0) {
    const purata = totalMurid ? Math.round((totalHadir/totalMurid)*100) : 0;
    analisisBox.innerHTML = `
      üí° <b>Analisis Semasa:</b> 
      ${jumlahIsi}/${jumlahKelas} kelas telah mengisi (${purata}% purata kehadiran).
    `;
  } else {
    analisisBox.innerText = "Tiada data kehadiran dimasukkan lagi.";
  }
}

// === Auto-simpan ke localStorage ===
const form = document.getElementById("formKehadiran");
form.addEventListener("input", () => {
  const data = Object.fromEntries(new FormData(form).entries());
  localStorage.setItem("draftKehadiran", JSON.stringify(data));
});
window.addEventListener("load", () => {
  const draft = JSON.parse(localStorage.getItem("draftKehadiran") || "{}");
  for (const [k,v] of Object.entries(draft)) {
    if (form[k]) form[k].value = v;
  }
});

// === Hantar data ke Apps Script ===
form.addEventListener("submit", async e => {
  e.preventDefault();
  const obj = Object.fromEntries(new FormData(form).entries());
  obj.tarikh = tarikh;
  obj.hari = hari;

  document.getElementById("status").innerText = "‚è≥ Menyimpan...";
  try {
    const res = await fetch(DEPLOY_URL, {
      method: "POST",
      body: JSON.stringify(obj),
      headers: { "Content-Type": "application/json" }
    });
    const json = await res.json();
    if (json.status === "ok") {
      document.getElementById("status").innerHTML = "<span class='saved'>‚úîÔ∏è Disimpan</span>";
      localStorage.removeItem("draftKehadiran");
      form.reset();
      loadData();
    } else {
      document.getElementById("status").innerHTML = "<span class='error'>‚ùå Ralat Simpan</span>";
    }
  } catch (err) {
    document.getElementById("status").innerHTML = "<span class='error'>‚ùå Gagal Hantar</span>";
  }
});

loadData();
</script>
</body>
</html>

