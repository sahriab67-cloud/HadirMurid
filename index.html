<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laporan Kehadiran Harian Murid STS — Analisis Tengah</title>
<style>
  :root{
    --blue:#0b63d6;
    --soft-blue:#e8f2ff;
    --muted:#6b7a90;
    --success:#e8fcef;
    --danger:#fff2f2;
    --card:#ffffff;
    --accent:#1e90ff;
    --green:#28a745;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:#f4f8ff;color:#10233b;margin:0;padding:18px}
  .wrap{max-width:1100px;margin:12px auto}
  header{display:flex;align-items:center;justify-content:space-between;background:var(--blue);color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 6px 18px rgba(11,99,214,0.12)}
  header h1{font-size:1rem;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .controls input[type=date], .controls input[type=text]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.08);color:#fff}
  .controls button{background:#fff;color:var(--blue);padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
  .card{background:var(--card);padding:14px;border-radius:10px;margin-top:14px;box-shadow:0 8px 24px rgba(16,35,59,0.06)}
  .topbar{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .topbar .info{color:var(--muted);font-weight:600}
  /* Centered Analysis */
  .analysis-center { display:flex; flex-direction:column; align-items:center; gap:14px; margin-top:12px; }
  .summary-mini{display:flex;gap:12px;align-items:center;color:var(--muted);font-weight:700}
  .summary-mini div{background:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,35,84,0.04);min-width:150px;text-align:center}
  .stat-cards{display:flex;gap:14px;margin-top:6px}
  .stat-card{width:260px;background:linear-gradient(180deg,#fff,#f7fbff);padding:14px;border-radius:10px;border:1px solid #e6eefc;box-shadow:0 8px 18px rgba(16,35,59,0.04);display:flex;flex-direction:column;align-items:center;gap:6px}
  .stat-card .label{color:var(--muted);font-weight:700}
  .stat-card .value{font-size:1.6rem;font-weight:800;color:var(--blue)}
  .progress-wrap{width:80%;background:#eaf2ff;padding:12px;border-radius:8px;border:1px solid #dbeeff}
  .progress-bar{height:20px;background:#dfeeff;border-radius:999px;overflow:hidden}
  .progress-fill{height:100%;width:0%;background:var(--green);transition:width 900ms cubic-bezier(.2,.9,.3,1)}
  /* table */
  table{width:100%;border-collapse:collapse;margin-top:18px;font-size:0.95rem}
  th,td{border:1px solid #e6eefc;padding:8px;text-align:center}
  th{background:var(--soft-blue);color:var(--blue);font-weight:700}
  td.left{text-align:left;padding-left:12px}
  tr.notfilled td{background:var(--danger)}
  tr.filled td{background:var(--success)}
  input.small{width:96%;padding:6px;border-radius:6px;border:1px solid #dbeafc}
  .status{margin-top:10px;text-align:center;font-weight:700;color:var(--muted)}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  @media(max-width:980px){ .stat-cards{flex-direction:column;align-items:center} header{flex-direction:column;align-items:flex-start;gap:8px} .summary-mini{flex-direction:column} .progress-wrap{width:100%} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Laporan Kehadiran Harian Murid STS</h1>
    <div class="controls" role="region" aria-label="admin-controls">
      <label style="display:flex;align-items:center;gap:6px;color:#fff">
        Tarikh <input id="tarikh" type="date" aria-label="Tarikh">
      </label>
      <label style="display:flex;align-items:center;gap:6px;color:#fff">
        Hari <input id="hari" type="text" placeholder="Contoh: Isnin" aria-label="Hari">
      </label>
      <button id="btnReset" title="Set Hari Baru">Set Hari Baru</button>
      <button id="btnRefresh" class="ghost" title="Segar Semula">Segar Semula</button>
      <button id="btnExport" class="ghost" title="Eksport CSV">Eksport CSV</button>
    </div>
  </header>

  <div class="card" role="main">
    <div class="topbar">
      <div class="info" id="countInfo">Memuat data...</div>
      <div class="actions"></div>
    </div>

    <!-- CENTERED ANALYSIS -->
    <div class="analysis-center" id="analysisCenter">
      <div class="summary-mini" id="summaryMini">
        <div id="miniKelas">Kelas Isi: 0 / 44</div>
        <div id="miniHadir">Murid Hadir: 0</div>
        <div id="miniPeratus">Peratus: 0%</div>
      </div>

      <div class="stat-cards" id="statCards">
        <div class="stat-card">
          <div class="label">Kelas Diisi</div>
          <div class="value" id="cardKelas">0 / 44</div>
          <div class="muted">Bilangan kelas yang sudah tekan simpan</div>
        </div>
        <div class="stat-card">
          <div class="label">Jumlah Murid Hadir</div>
          <div class="value" id="cardHadir">0</div>
          <div class="muted">Jumlah semua murid hadir hari ini</div>
        </div>
        <div class="stat-card">
          <div class="label">Jumlah Murid (Keseluruhan)</div>
          <div class="value" id="cardJumlah">0</div>
          <div class="muted">Jumlah murid berdaftar (ruangan 'JUMLAH MURID')</div>
        </div>
      </div>

      <div class="progress-wrap" style="margin-top:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;font-weight:700;color:var(--muted);margin-bottom:8px">
          <div>Peratus Kehadiran</div>
          <div id="percentLabel">0%</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
    </div>
    <!-- END ANALYSIS -->

    <!-- Table -->
    <table id="kehadiranTbl" aria-describedby="desc">
      <thead>
        <tr>
          <th style="min-width:150px">KELAS</th>
          <th>NAMA PENGISI</th>
          <th style="width:90px">BIL. HADIR</th>
          <th style="width:110px">JUMLAH MURID</th>
          <th>CATATAN</th>
          <th style="width:90px">TINDAKAN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="status" id="statusMsg">Status: menunggu muat data...</div>
  </div>
</div>

<script>
/* ============== CONFIG ============== */
/* Web App exec URL — gunakan URL cikgu yang sudah deploy */
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyK_qh_CV3fdyq-dsLbJCboDvTXoHs6aUlpHCq26SJAc8T3lbkslfep2nLqsDUzzTJm/exec";

/* Senarai kelas tetap */
const KELAS_LIST = [
"1CEMPAKA","1KAA","1KENANGA","1MAWAR","1ORKID","1SEROJA",
"2CEMPAKA","2KAA","2KENANGA","2MAWAR","2ORKID","2SEROJA",
"3CEMPAKA","3KAA","3KENANGA","3MAWAR","3ORKID","3SEROJA",
"4AKAUN","4SAINS","4SENI 1","4SENI 2","4SENI 3","4TSWR",
"5AKAUN","5SAINS","5SENI 1","5SENI 2","5SENI 3","5TSWR",
"L6A1","L6A2","L6A3","L6A4","L6S1","L6S2","L6S3",
"U6A1","U6A2","U6A3","U6A4","U6S1","U6S2","U6S3"
];
/* ===================================== */

const tbody = document.querySelector("#kehadiranTbl tbody");
const statusMsg = document.getElementById("statusMsg");
const countInfo = document.getElementById("countInfo");
const tarikhEl = document.getElementById("tarikh");
const hariEl = document.getElementById("hari");
const btnReset = document.getElementById("btnReset");
const btnRefresh = document.getElementById("btnRefresh");
const btnExport = document.getElementById("btnExport");

const miniKelas = document.getElementById("miniKelas");
const miniHadir = document.getElementById("miniHadir");
const miniPeratus = document.getElementById("miniPeratus");
const cardKelas = document.getElementById("cardKelas");
const cardHadir = document.getElementById("cardHadir");
const cardJumlah = document.getElementById("cardJumlah");
const percentLabel = document.getElementById("percentLabel");
const progressFill = document.getElementById("progressFill");

/* Escape */
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function rowHTML(kelas, dataRow) {
  const pengisi = (dataRow && (dataRow["NAMA PENGISI"]||"")) || "";
  const hadir = (dataRow && (dataRow["BIL. HADIR"]||"")) || "";
  const jumlah = (dataRow && (dataRow["JUMLAH MURID"]||"")) || "";
  const catatan = (dataRow && (dataRow["CATATAN"]||"")) || "";
  const isFilled = pengisi && String(pengisi).trim() !== "";
  return `
    <tr class="${isFilled ? "filled" : "notfilled"}">
      <td class="left">${kelas}</td>
      <td><input class="pengisi small" data-kelas="${kelas}" value="${escapeHtml(pengisi)}" /></td>
      <td><input class="hadir small" data-kelas="${kelas}" type="number" min="0" value="${escapeHtml(hadir)}" /></td>
      <td><input class="jumlah small" data-kelas="${kelas}" type="number" min="0" value="${escapeHtml(jumlah)}" /></td>
      <td><input class="catatan small" data-kelas="${kelas}" value="${escapeHtml(catatan)}" /></td>
      <td><button class="saveBtn" data-kelas="${kelas}">Simpan</button></td>
    </tr>
  `;
}

/* Load data (GET) and render table + update analytics */
async function loadData(){
  statusMsg.textContent = "🔄 Memuat data...";
  try {
    const tarikh = tarikhEl.value;
    const url = tarikh ? GOOGLE_WEBAPP_URL + "?date=" + encodeURIComponent(tarikh) : GOOGLE_WEBAPP_URL;
    const res = await fetch(url);
    const text = await res.text();
    let rows = [];
    try { rows = JSON.parse(text); } catch (e) {
      statusMsg.textContent = "❌ Gagal baca data daripada server: " + text;
      console.error("parse error", e, text);
      return;
    }

    // If no date chosen by user, pick the first row's TARIKH
    if (!tarikh) {
      const first = rows.find(r => r["TARIKH"]);
      if (first && first["TARIKH"]) tarikhEl.value = first["TARIKH"];
    }
    // Fill hari if empty
    if (!hariEl.value && rows.length) {
      const any = rows.find(r => r["HARI"]);
      if (any && any["HARI"]) hariEl.value = any["HARI"];
    }

    // map by kelas for chosen date
    const map = {};
    rows.forEach(r => { if (r["KELAS"]) map[r["KELAS"]] = r; });

    tbody.innerHTML = "";
    let filled = 0;
    let sumHadir = 0;
    let sumJumlah = 0;
    KELAS_LIST.forEach(k => {
      const r = map[k] || null;
      tbody.insertAdjacentHTML('beforeend', rowHTML(k, r));
      if (r) {
        const p = (r["NAMA PENGISI"]||"").toString().trim();
        if (p) filled++;
        const h = Number(r["BIL. HADIR"]) || 0;
        const j = Number(r["JUMLAH MURID"]) || 0;
        sumHadir += h;
        sumJumlah += j;
      }
    });

    // Update summary mini
    miniKelas.textContent = `Kelas Isi: ${filled} / ${KELAS_LIST.length}`;
    miniHadir.textContent = `Murid Hadir: ${sumHadir}`;
    const percent = sumJumlah > 0 ? (sumHadir / sumJumlah) * 100 : 0;
    miniPeratus.textContent = `Peratus: ${percent.toFixed(1)}%`;

    // Update cards
    cardKelas.textContent = `${filled} / ${KELAS_LIST.length}`;
    cardHadir.textContent = `${sumHadir}`;
    cardJumlah.textContent = `${sumJumlah}`;

    // Update progress bar & label with animation
    const pct = Math.max(0, Math.min(100, Math.round(percent * 10) / 10));
    percentLabel.textContent = `${pct}%`;
    setTimeout(()=>{ progressFill.style.width = pct + "%"; }, 40);

    countInfo.textContent = `Diisi: ${filled} / ${KELAS_LIST.length}`;
    statusMsg.textContent = "✅ Data dimuat.";
    bindSaveButtons();
  } catch (err) {
    console.error("loadData error", err);
    statusMsg.textContent = "❌ Ralat muat data: " + err;
  }
}

function bindSaveButtons(){
  document.querySelectorAll(".saveBtn").forEach(b => {
    b.onclick = () => simpanBaris(b.dataset.kelas, b);
  });
}

/* Save a single row — use mode:no-cors to avoid preflight issues from GitHub Pages */
async function simpanBaris(kelas, btn){
  btn.disabled = true; btn.textContent = "Menghantar...";
  const pengisi = document.querySelector(`.pengisi[data-kelas='${kelas}']`).value || "";
  const hadir = document.querySelector(`.hadir[data-kelas='${kelas}']`).value || "";
  const jumlah = document.querySelector(`.jumlah[data-kelas='${kelas}']`).value || "";
  const catatan = document.querySelector(`.catatan[data-kelas='${kelas}']`).value || "";
  const tarikh = tarikhEl.value || "";
  const hari = hariEl.value || "";

  if (!tarikh || !hari) { alert("Sila isi Tarikh & Hari di atas terlebih dahulu."); btn.disabled=false; btn.textContent="Simpan"; return; }

  const payload = { tarikh, hari, kelas, pengisi, hadir, jumlah, catatan };

  try {
    await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    statusMsg.textContent = `✅ Data kelas ${kelas} dihantar. Menunggu muat semula...`;
    // short delay to allow server write
    setTimeout(loadData, 800);
  } catch (err) {
    console.error("POST error", err);
    statusMsg.textContent = "❌ Gagal hantar: " + err;
  } finally {
    btn.disabled = false; btn.textContent = "Simpan";
  }
}

/* Set Hari Baru — create/reset sheet for chosen date with kelas rows */
btnReset.addEventListener("click", async () => {
  if (!confirm("Anda pasti nak 'Set Hari Baru'? Ini akan reset baris untuk tarikh ini.")) return;
  const tarikh = tarikhEl.value;
  const hari = hariEl.value || "";
  if (!tarikh || !hari) { alert("Sila pilih Tarikh & Hari di atas sebelum reset."); return; }

  try {
    await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "reset", tarikh, hari })
    });
    statusMsg.textContent = "🔄 Reset dihantar. Memuat semula...";
    setTimeout(loadData, 900);
  } catch (err) {
    console.error("reset error", err);
    statusMsg.textContent = "❌ Gagal reset: " + err;
  }
});

btnRefresh.addEventListener("click", loadData);

btnExport.addEventListener("click", () => {
  const tarikh = tarikhEl.value || "tanpa_tarikh";
  const hari = hariEl.value || "";
  let csv = "Tarikh,Hari,Kelas,Nama Pengisi,Bil Hadir,Jumlah Murid,Catatan\n";
  document.querySelectorAll("#kehadiranTbl tbody tr").forEach(tr => {
    const kelas = tr.querySelector("td:first-child").textContent.trim();
    const pengisi = tr.querySelector(".pengisi").value.replace(/"/g,'""');
    const hadir = tr.querySelector(".hadir").value;
    const jumlah = tr.querySelector(".jumlah").value;
    const catatan = tr.querySelector(".catatan").value.replace(/"/g,'""');
    csv += `"${tarikh}","${hari}","${kelas}","${pengisi}","${hadir}","${jumlah}","${catatan}"\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Kehadiran_${tarikh}.csv`;
  a.click();
});

/* On load: default date = 2025-10-31 (supaya boleh terus guna esok) */
window.addEventListener("load", () => {
  // set default to 31 Oct 2025 as requested
  const defaultDate = "2025-10-31";
  if (!tarikhEl.value) {
    tarikhEl.value = defaultDate;
    const hariNames = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
    // 2025-10-31 is Jumaat; but compute just in case
    const d = new Date(defaultDate + "T00:00:00");
    hariEl.value = hariNames[d.getDay()] || "Jumaat";
  }
  loadData();
});
</script>
</body>
</html>
